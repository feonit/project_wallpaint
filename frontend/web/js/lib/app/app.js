/*! wallpaint - v0.0.1 - 2013-11-26 */require.config({paths:{jquery:"/public/js/lib/jquery/jquery.min",socket:"/public/js/lib/app/socket",picker:"/public/js/lib/app/picker",colorpicker:"/public/js/lib/util/colorpicker",jqueryui:"/public/js/lib/jquery/jquery-ui"}});var App={};require(["jquery","socket","picker","colorpicker","jqueryui"],function(e,t,a){App.DEFAULT_COLOR={r:0,g:0,b:0},App.DEFAULT_SIZE=3,App.DEFAULT_OPACITY=100,App.DEFAULT_HEIGHT=400,App.DEFAULT_WIDTH=600,App.LOGIN="user"+(new Date).getTime(),App.PAGE=location.pathname.replace("/",""),App.DEFAULT_SCALE=100,App.MIN_SCALE=10,App.MAX_SCALE=400,App.SCALE=10,App.HOST=-1!==location.host.search("localhost")?"127.0.0.1:"+location.port:location.host,App.socket=t,App.store={data:[],count:0,getData:function(e){this.data=e,this.count+=e.length},drawStore:function(){for(var e=this.count,t=0;e>t;t++)App.drawLine(App.store.data[t])}},App.reDraw=function(e,t){if("number"==typeof e.x[0]){if(t.beginPath(),t.moveTo(e.x[0],e.y[0]),2>e.x.length)t.lineTo(e.x[0]+.51,e.y[0]);else if(3>e.x.length)t.lineTo(e.x[1],e.y[1]);else{t.moveTo(.5*(e.x[0]+e.x[1]),.5*(e.y[0]+e.y[1]));for(var a=0;++a<e.x.length-1;){var p=Math.abs(e.x[a-1]-e.x[a])+Math.abs(e.y[a-1]-e.y[a])+Math.abs(e.x[a]-e.x[a+1])+Math.abs(e.y[a]-e.y[a+1]),o=Math.abs(e.x[a-1]-e.x[a+1])+Math.abs(e.y[a-1]-e.y[a+1]);p>10&&o>.8*p?t.quadraticCurveTo(e.x[a],e.y[a],.5*(e.x[a]+e.x[a+1]),.5*(e.y[a]+e.y[a+1])):t.lineTo(.5*(e.x[a]+e.x[a+1]),.5*(e.y[a]+e.y[a+1]))}}return t.stroke(),t.closePath()}},App.drawLine=function(t){var a=t.x,p=t.y,o=t.r,i=t.g,r=t.b,n=t.size,c=t.opacity/100,s="rgb("+o+","+i+","+r+")",l=t.login;if(!(1>c)){if(App.ctx.globalAlpha=1,-100==a)return App.storeByName[l]=[];App.storeByName[l]||(App.storeByName[l]=[]),App.storeByName[l].push(t);var A=App.storeByName[l],u=App.storeByName[l].length-1;App.ctx.strokeStyle=s,App.ctx.lineWidth=n;var d={x:[],y:[]};if(2>u)for(;u>=0;u--)d.x.push(A[u].x),d.y.push(A[u].y);else for(var f=u-3;u>f;)f++,d.x.push(A[f].x),d.y.push(A[f].y);return App.reDraw(d,App.ctx)}var h=e("#_"+l)[0],v=h||App.createCanvas("_"+l);return-100!==a?(v.ctx.strokeStyle=s,v.ctx.lineWidth=n,v.ctx.globalAlpha=c,v.mouseXY.x.push(a),v.mouseXY.y.push(p),v.ctx.clearRect(0,0,App.canvas.width,App.canvas.height),App.reDraw(v.mouseXY,v.ctx)):(App.ctx.strokeStyle=s,App.ctx.globalAlpha=c,App.ctx.lineWidth=n,App.reDraw(v.mouseXY,App.ctx),v.mouseXY={x:[],y:[]},v.ctx.clearRect(0,0,App.canvas.width,App.canvas.height),void 0)},App.createCanvas=function(t){var a=e("<canvas />").appendTo("#allCanvas")[0];return 1!==e("#allCanvas").children().length&&e(a).addClass("canvasLayer"),a.id=t,a.height=App.DEFAULT_HEIGHT,a.width=App.DEFAULT_WIDTH,a.mouseXY={x:[],y:[]},a.ctx=a.getContext("2d"),a.ctx.lineCap="round",a.ctx.lineJoin="round",a},App.refresh=function(){App.ctx.clearRect(0,0,App.canvas.width,App.canvas.height),e(".canvasLayer").remove()},App.init=function(){App.demoPicker=a.init(App.DEFAULT_SIZE),App.canvas=App.createCanvas(App.LOGIN),App.ctx=App.canvas.ctx,App.ctx.color=App.DEFAULT_COLOR,App.ctx.opacity=App.DEFAULT_OPACITY,App.ctx.size=App.DEFAULT_SIZE,App.storeByName={},App.createDraw=function(e,t){return{x:e,y:t,size:App.ctx.size,r:App.ctx.color.r,g:App.ctx.color.g,b:App.ctx.color.b,opacity:App.ctx.opacity,nameFromPath:App.PAGE,login:App.LOGIN}}},e(function(){function t(){var t=e("canvas")[0],a=e("#allCanvas")[0],p=t.offsetWidth/App.canvas.width,o=t.offsetHeight/App.canvas.height,i=Math.floor((event.pageX-A.offsetLeft-a.offsetLeft-t.offsetLeft)/p),r=Math.floor((event.pageY-A.offsetTop-a.offsetTop-t.offsetTop)/o);return{x:i,y:r}}function a(){App.refresh(),App.socket.emit("clearAllCanvas",{nameFromPath:App.PAGE})}function p(e){if(!e.button){var a=t(),p=a.x,o=a.y,i=App.createDraw(p,o);App.socket.emit("drawClick",i),App.drawLine(i),x=!0}}function o(e){if((x||!g)&&!e.button){var a=t(),p=a.x,o=a.y,i=App.createDraw(p,o);App.socket.emit("drawClick",i),App.drawLine(i)}}function i(){x=!1;var e=App.createDraw(-100,-100);App.socket.emit("drawClick",e),App.drawLine(e)}function r(){var e=v.draggable("option","disabled");e?(v.draggable("option","disabled",!1),u.unbind("mousedown",p),v.css("cursor","all-scroll")):(v.draggable("option","disabled",!0),u.bind("mousedown",p),v.css("cursor","crosshair"))}function n(){App.ctx.color={r:255,g:255,b:255}}function c(){var e=d.slider("option","value")-App.SCALE;e>App.MIN_SCALE&&d.slider("option","value",e)}function s(){var e=d.slider("option","value")+App.SCALE;App.MAX_SCALE>e&&d.slider("option","value",e)}function l(e){if(e.stopPropagation(),e.preventDefault(),e.originalEvent instanceof WheelEvent){var t=d.slider("option","value");t+=e.originalEvent.wheelDelta/120,t>App.MIN_SCALE&&App.MAX_SCALE>t&&d.slider("option","value",t)}return!1}App.init(),App.demoPicker.init();var A=e("#placeCanvas")[0],u=e("body"),d=e("#sliderScale"),f=e("#sliderSize"),h=e("#sliderOpacity"),v=e("#allCanvas"),b=e("#imageData");b.load(function(){App.ctx.drawImage(b[0],0,0)});var m=function(e,t){A.offsetWidth/100,A.offsetHeight/100,v[0].offsetLeft,v[0].offsetTop;var a=t.value;a>100?(v.css("left",-Math.abs((a-100)/2)+"%"),v.css("top",-Math.abs((a-100)/2)+"%")):(v.css("left",Math.abs((a-100)/2)+"%"),v.css("top",Math.abs((a-100)/2)+"%")),v.css("width",a+"%"),v.css("height",a+"%")};h.slider({min:1,max:100,step:1,value:App.DEFAULT_OPACITY,animate:"fast",orientation:"horizontal",range:!1,slide:function(e,t){App.ctx.opacity=t.value,App.demoPicker.redrawPicker(),g=!1},start:function(e){e.stopImmediatePropagation()},stop:function(){g=!0}}),f.slider({min:1,max:100,step:1,value:App.DEFAULT_SIZE,animate:"fast",orientation:"horizontal",range:!1,slide:function(e,t){var a=A.offsetWidth/App.canvas.width,p=t.value;App.ctx.size=p/a,App.demoPicker.redrawPicker(p),g=!1},start:function(e){e.stopImmediatePropagation()},stop:function(){g=!0}}),d.slider({min:10,max:400,step:1,value:App.DEFAULT_SCALE,animate:"fast",orientation:"horizontal",range:!1,change:m,slide:m,start:function(e){u.unbind("mousedown",p),e.stopImmediatePropagation()},stop:function(){u.bind("mousedown",p)}});var y=document.getElementById("color-picker");y&&ColorPicker(y,function(e,t,a){App.ctx.color=a,App.demoPicker.redrawPicker()}),document.onselectstart=function(){return!1};var g=!0,x=!1;v.draggable({opacity:1}),v.draggable("option","disabled",!0),e("#slider-panel").draggable(),e("#color-panel").draggable(),e("#image-panel").draggable(),e("#clear").bind("click",a),e("#eraser").bind("click",n),e("#zoomOut").bind("click",c),e("#zoomIn").bind("click",s),e("#hand").bind("click",r),e(".side").bind("blur"),v.bind("mousewheel",l),v.bind("mousewheel",l),v.bind("click",function(e){1==e.button&&r()}),u.bind("mousedown",p),u.bind("mousemove",o),u.bind("mouseup",i)})});